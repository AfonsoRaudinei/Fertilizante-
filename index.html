<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Fertilizantes</title>
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #0051D5;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FFB74D;
            --gray-100: #F5F5F7;
            --gray-200: #E5E5E7;
            --gray-400: #D1D1D6;
            --gray-600: #86868B;
            --gray-900: #1D1D1F;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 10px;
            --radius-xl: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,122,255,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, var(--gray-100) 0%, var(--gray-200) 100%);
            padding: 10px;
            min-height: 100vh;
        }

        .container { max-width: 100%; margin: 0 auto; }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }

        h1 { font-size: 16px; font-weight: 600; color: var(--gray-900); margin-bottom: 12px; }

        h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        label {
            font-size: 10px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 4px;
            text-transform: uppercase;
            display: block;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--gray-400);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: white;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        input:disabled {
            background: var(--gray-100);
            color: #C7C7CC;
            cursor: not-allowed;
        }

        .header-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .nutrients-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .fert-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 8px; }
        .secondary-grid { display: none; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 8px; }
        .secondary-grid.show { display: grid; }
        .values-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 8px; }
        .prices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .nutrient-badge {
            background: var(--gray-100);
            padding: 12px;
            border-radius: var(--radius-lg);
            text-align: center;
            border: 2px solid var(--gray-200);
        }

        .nutrient-badge.primary {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(0,122,255,0.1), rgba(0,122,255,0.05));
        }

        .nutrient-badge.secondary {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(52,199,89,0.1), rgba(52,199,89,0.05));
        }

        .nutrient-badge input {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .priority { font-size: 9px; font-weight: 600; margin-top: 6px; text-transform: uppercase; }
        .primary .priority { color: var(--primary); }
        .secondary .priority { color: var(--success); }

        .input-card {
            background: var(--gray-100);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-bottom: 12px;
        }

        .fert-item {
            background: var(--gray-100);
            padding: 14px;
            border-radius: var(--radius-xl);
            margin-bottom: 10px;
            border: 2px solid var(--gray-200);
        }

        .fert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .fert-name { font-weight: 600; color: var(--gray-900); font-size: 15px; }
        .fert-formula { font-size: 12px; color: var(--gray-600); }

        .fert-actions { display: flex; gap: 6px; }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-icon:hover { transform: scale(1.1); }
        .btn-edit { background: var(--primary); }
        .btn-edit:hover { background: var(--primary-dark); }
        .btn-remove { background: var(--danger); font-weight: 300; }
        .btn-remove:hover { background: #e53329; }

        .value-item { text-align: center; }
        .value-label { font-size: 9px; color: var(--gray-600); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 13px; font-weight: 600; color: var(--gray-900); }

        .price-item {
            background: white;
            padding: 8px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); }

        .btn-add, .btn-save {
            background: var(--success);
            color: white;
        }

        .btn-cancel {
            background: var(--gray-600);
            color: white;
            margin-top: 8px;
        }

        .toggle-expand {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .toggle-expand:hover { background: rgba(0,122,255,0.1); }
        .expand-icon { transition: transform 0.3s; }
        .expand-icon.open { transform: rotate(180deg); }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .badge-best { background: var(--success); color: white; }

        .result {
            padding: 16px;
            border-radius: var(--radius-xl);
            margin-bottom: 12px;
            border: 2px solid #81C784;
        }

        .result.best {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
        }

        .result.second {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border-color: var(--warning);
        }

        .result h3 {
            font-size: 15px;
            color: #2E7D32;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .result.second h3 { color: #E65100; }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .result-total {
            font-weight: 600;
            font-size: 16px;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 2px solid #2E7D32;
            display: flex;
            justify-content: space-between;
        }

        .grain-info {
            background: rgba(0,122,255,0.08);
            border: 1px solid rgba(0,122,255,0.3);
            padding: 12px;
            border-radius: var(--radius-md);
            margin-top: 10px;
            font-size: 12px;
        }

        .grain-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .grain-value { font-weight: 600; color: var(--primary); }

        .empty { text-align: center; padding: 24px; color: var(--gray-600); font-size: 13px; }

        /* MODAL DE FILTROS */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid var(--gray-200);
            background: linear-gradient(135deg, var(--gray-100), white);
        }

        .modal-header h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .modal-header p {
            font-size: 13px;
            color: var(--gray-600);
            line-height: 1.4;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .filter-section {
            background: var(--gray-100);
            padding: 16px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            border: 2px solid var(--gray-200);
        }

        .filter-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-help {
            font-size: 11px;
            color: var(--gray-600);
            margin-top: 6px;
            line-height: 1.4;
        }

        .filter-checkbox-row {
            display: flex;
            gap: 10px;
            cursor: pointer;
        }

        .filter-checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .filter-checkbox-row label {
            cursor: pointer;
            text-transform: none;
            font-size: 13px;
            color: var(--gray-900);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-checkbox-row label strong {
            font-size: 14px;
        }

        #fertilizersCheckList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .fert-check-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .fert-check-item:hover {
            background: var(--gray-200);
        }

        .fert-check-item.excluded {
            background: rgba(255,59,48,0.08);
            border-color: var(--danger);
        }

        .fert-check-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .fert-check-info {
            flex: 1;
        }

        .fert-check-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--gray-900);
        }

        .fert-check-formula {
            font-size: 11px;
            color: var(--gray-600);
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 2px solid var(--gray-200);
            display: flex;
            gap: 10px;
            background: var(--gray-100);
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: white;
            color: var(--gray-900);
            border: 2px solid var(--gray-400);
        }

        .modal-btn.cancel:hover {
            background: var(--gray-200);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .modal-btn.confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,122,255,0.4);
        }

        /* Toast, Save Badge, Loading */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            color: white;
            font-size: 13px;
            font-weight: 600;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            max-width: 300px;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }

        .save-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52,199,89,0.95);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .save-badge.show { opacity: 1; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 998;
        }

        .loading-overlay.show { display: flex; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .header-grid, .nutrients-grid { grid-template-columns: 1fr; }
            .fert-row { grid-template-columns: repeat(3, 1fr); }
            .values-grid { grid-template-columns: repeat(3, 1fr); }
            
            .modal {
                max-width: 100%;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üåæ Calculadora de Fertilizantes</h1>
            <div class="header-grid">
                <div>
                    <label>Cultura</label>
                    <select id="crop">
                        <option value="soja">üå± Soja</option>
                        <option value="milho">üåΩ Milho</option>
                    </select>
                </div>
                <div>
                    <label>√Årea (ha)</label>
                    <input type="number" id="area" value="100" step="0.1">
                </div>
                <div>
                    <label id="grainLabel">Soja (R$/sc)</label>
                    <input type="number" id="grainPrice" value="120" step="0.1">
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üéØ Necessidades (kg/ha)</h2>
            <div class="nutrients-grid" id="nutrients"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2 style="margin: 0;">üìã Fertilizantes</h2>
                <div class="toggle-expand" id="toggleFormCard" style="margin: 0; padding: 6px 12px;">
                    <span class="expand-icon" id="formIcon">‚ñ≤</span>
                    <span style="font-size: 11px;">Formul√°rio</span>
                </div>
            </div>
            
            <div id="formCard">
                <div class="input-card">
                    <div style="margin-bottom: 12px;">
                        <label>Nome</label>
                        <input type="text" id="name" placeholder="Ex: MAP, KCl, Ureia">
                    </div>

                    <div class="fert-row">
                        <div><label>N (%)</label><input type="number" id="n" value="0" step="0.1" min="0" max="100"></div>
                        <div><label>P‚ÇÇO‚ÇÖ (%)</label><input type="number" id="p" value="0" step="0.1" min="0" max="100"></div>
                        <div><label>K‚ÇÇO (%)</label><input type="number" id="k" value="0" step="0.1" min="0" max="100"></div>
                        <div><label>Pre√ßo (R$/ton)</label><input type="number" id="price" step="10" min="0"></div>
                        <div><label>Frete (R$/ton)</label><input type="number" id="freight" value="0" step="10" min="0"></div>
                    </div>

                    <div class="toggle-expand" id="toggleSecondary">
                        <span class="expand-icon" id="icon">‚ñ≤</span>
                        <span>Ca, S, B e outros</span>
                    </div>

                    <div class="secondary-grid" id="secondary">
                        <div><label>Ca %</label><input type="number" id="ca" value="0" step="0.1" min="0" max="100"></div>
                        <div><label>S %</label><input type="number" id="s" value="0" step="0.1" min="0" max="100"></div>
                        <div><label>B %</label><input type="number" id="b" value="0" step="0.01" min="0" max="100"></div>
                        <div><label>Outros %</label><input type="number" id="other" value="0" step="0.1" min="0" max="100"></div>
                    </div>

                    <button class="btn-add" id="addBtn">+ Adicionar</button>
                    <button class="btn-save" id="saveBtn" style="display:none;">üíæ Salvar</button>
                    <button class="btn-cancel" id="cancelBtn" style="display:none;">Cancelar</button>
                </div>
            </div>
            
            <!-- Toggle para mostrar/ocultar lista -->
            <div class="toggle-expand" id="toggleList" style="margin-top: 16px;">
                <span class="expand-icon open" id="listIcon">‚ñº</span>
                <span id="listToggleText">Mostrar lista de fertilizantes</span>
            </div>
            
            <div id="list"></div>
        </div>

        <button class="btn-primary" id="calcBtn">üí∞ Calcular Melhores Combina√ß√µes</button>
        <div id="results"></div>
    </div>

    <!-- MODAL DE FILTROS -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>üéØ Filtros de Combina√ß√µes</h3>
                <p>Configure os crit√©rios para calcular as melhores combina√ß√µes:</p>
            </div>
            <div class="modal-body" id="modalBody">
                
                <!-- Filtro 1: Limite K em fertilizante de P -->
                <div class="filter-section">
                    <div class="filter-title">
                        <span>‚ö†Ô∏è Limite K‚ÇÇO em Fertilizante de F√≥sforo</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="kLimitInP" value="20" step="5" min="0" 
                               style="flex: 1; max-width: 120px;">
                        <span style="font-size: 13px; color: var(--gray-600);">kg/ha</span>
                    </div>
                    <p class="filter-help">
                        M√°ximo de K‚ÇÇO permitido em fertilizantes formulados (com P+K). Zero = sem limite.
                    </p>
                </div>

                <!-- Filtro 2: Preferir KCl com Boro -->
                <div class="filter-section">
                    <div class="filter-checkbox-row">
                        <input type="checkbox" id="preferKClWithB">
                        <label for="preferKClWithB">
                            <strong>üéØ Preferir KCl com Boro</strong>
                            <span class="filter-help">Prioriza fontes de pot√°ssio que contenham boro (ex: KCl + B)</span>
                        </label>
                    </div>
                </div>

                <!-- Filtro 3: Exclus√£o manual de fertilizantes -->
                <div class="filter-section">
                    <div class="filter-title">
                        <span>üö´ Excluir Fertilizantes Espec√≠ficos</span>
                    </div>
                    <p class="filter-help" style="margin-bottom: 8px;">
                        Marque os fertilizantes que n√£o devem entrar nas combina√ß√µes:
                    </p>
                    <div id="fertilizersCheckList"></div>
                </div>

                <!-- Filtro 4: Limite de custo -->
                <div class="filter-section">
                    <div class="filter-title">
                        <span>üí∞ Limite de Custo por Hectare (opcional)</span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" id="costLimit" value="0" step="100" min="0" 
                               placeholder="0 = sem limite"
                               style="flex: 1; max-width: 150px;">
                        <span style="font-size: 13px; color: var(--gray-600);">R$/ha</span>
                    </div>
                    <p class="filter-help">
                        Descarta combina√ß√µes que excedam este custo. Zero = sem limite.
                    </p>
                </div>

            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="modalCancel">Cancelar</button>
                <button class="modal-btn confirm" id="modalConfirm">üí∞ Calcular</button>
            </div>
        </div>
    </div>

    <div class="save-badge" id="saveBadge">‚úì Salvo</div>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
        const CONSTANTS = {
            STORAGE_KEY: 'fertCalc_v3',
            MAX_NUTRIENT_PERCENT: 100,
            TOAST_DURATION: 3000
        };

        // Base de dados padr√£o de fertilizantes Cibra
        const DEFAULT_FERTILIZERS = [
            // Fontes puras
            { name: "MAP 11-52/44 GR", n: 11, p: 52, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 3800, freight: 0 },
            { name: "KCL 60 GR", n: 0, p: 0, k: 60, ca: 0, s: 0, b: 0, other: 0, price: 2800, freight: 0 },
            { name: "UREIA 46 GR", n: 46, p: 0, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2600, freight: 0 },
            { name: "SAM 20,5/23 GR", n: 20.5, p: 0, k: 0, ca: 0, s: 23, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "SSP 20/16 GR", n: 0, p: 20, k: 0, ca: 16, s: 11, b: 0, other: 0, price: 1800, freight: 0 },
            { name: "SSP 19/16 + 16CA + 11S/SO4 GR", n: 0, p: 19, k: 0, ca: 16, s: 11, b: 0, other: 0, price: 1850, freight: 0 },
            { name: "TSP 46/36 GR", n: 0, p: 46, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 3200, freight: 0 },
            
            // Formulados NPK - S√©rie 02-XX-XX
            { name: "02-14-12 MG", n: 2, p: 14, k: 12, ca: 0, s: 0, b: 0, other: 0, price: 2200, freight: 0 },
            { name: "02-17-24 MG", n: 2, p: 17, k: 24, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "02-20-20 MG", n: 2, p: 20, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2350, freight: 0 },
            { name: "02-24-12 MG", n: 2, p: 24, k: 12, ca: 0, s: 0, b: 0, other: 0, price: 2300, freight: 0 },
            { name: "02-25-00 MG", n: 2, p: 25, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2100, freight: 0 },
            { name: "02-25-25 MG", n: 2, p: 25, k: 25, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "02-30-10 MG", n: 2, p: 30, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            
            // Formulados NPK - S√©rie 03-XX-XX
            { name: "03-28-00 MG", n: 3, p: 28, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2200, freight: 0 },
            { name: "03-30-15 MG", n: 3, p: 30, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "03-32-08 MG", n: 3, p: 32, k: 8, ca: 0, s: 0, b: 0, other: 0, price: 2450, freight: 0 },
            
            // Formulados NPK - S√©rie 04-XX-XX
            { name: "04-14-08 MG", n: 4, p: 14, k: 8, ca: 0, s: 0, b: 0, other: 0, price: 2100, freight: 0 },
            { name: "04-20-20 MG", n: 4, p: 20, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "04-26-10 MG", n: 4, p: 26, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2350, freight: 0 },
            { name: "04-30-10 MG", n: 4, p: 30, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2450, freight: 0 },
            { name: "04-35-10 MG", n: 4, p: 35, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2550, freight: 0 },
            { name: "04-40-08 MG", n: 4, p: 40, k: 8, ca: 0, s: 0, b: 0, other: 0, price: 2600, freight: 0 },
            
            // Formulados NPK - S√©rie 05-XX-XX
            { name: "05-20-30 MG", n: 5, p: 20, k: 30, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "05-25-15 MG", n: 5, p: 25, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "05-25-25 MG", n: 5, p: 25, k: 25, ca: 0, s: 0, b: 0, other: 0, price: 2550, freight: 0 },
            { name: "05-25-30 MG", n: 5, p: 25, k: 30, ca: 0, s: 0, b: 0, other: 0, price: 2600, freight: 0 },
            { name: "05-35-00 MG", n: 5, p: 35, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            
            // Formulados NPK - S√©rie 06-XX-XX
            { name: "06-28-20 + 1%Zn", n: 6, p: 28, k: 20, ca: 0, s: 0, b: 0, other: 1, price: 2700, freight: 0 },
            { name: "06-30-06 MG", n: 6, p: 30, k: 6, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "06-30-10 +0,5B+0,75Zn MG", n: 6, p: 30, k: 10, ca: 0, s: 0, b: 0.5, other: 0.75, price: 2700, freight: 0 },
            { name: "06-37-00 MG", n: 6, p: 37, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2600, freight: 0 },
            
            // Formulados NPK - S√©rie 07-XX-XX
            { name: "07-34-09 MG", n: 7, p: 34, k: 9, ca: 0, s: 0, b: 0, other: 0, price: 2700, freight: 0 },
            { name: "07-40-00 MG", n: 7, p: 40, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2750, freight: 0 },
            
            // Formulados NPK - S√©rie 08-XX-XX
            { name: "08-00-36 MG", n: 8, p: 0, k: 36, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "08-20-20 MG", n: 8, p: 20, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "08-28-16 MG", n: 8, p: 28, k: 16, ca: 0, s: 0, b: 0, other: 0, price: 2700, freight: 0 },
            { name: "08-28-16 + 1% ZN MG", n: 8, p: 28, k: 16, ca: 0, s: 0, b: 0, other: 1, price: 2750, freight: 0 },
            { name: "08-40-07 +0,5B+0,75ZN MG", n: 8, p: 40, k: 7, ca: 0, s: 0, b: 0.5, other: 0.75, price: 2900, freight: 0 },
            { name: "08-40-08 MG", n: 8, p: 40, k: 8, ca: 0, s: 0, b: 0, other: 0, price: 2850, freight: 0 },
            
            // Formulados NPK - S√©rie 09-XX-XX e 10-XX-XX
            { name: "09-46-00 MG", n: 9, p: 46, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2900, freight: 0 },
            { name: "10-10-10 MG", n: 10, p: 10, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2200, freight: 0 },
            { name: "10-15-15 MG", n: 10, p: 15, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "10-20-10 MG", n: 10, p: 20, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2450, freight: 0 },
            { name: "10-30-10 MG", n: 10, p: 30, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2650, freight: 0 },
            { name: "10-49-00 + 0,75% ZN MG", n: 10, p: 49, k: 0, ca: 0, s: 0, b: 0, other: 0.75, price: 3000, freight: 0 },
            { name: "10-50-00 MG", n: 10, p: 50, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 3050, freight: 0 },
            
            // Formulados NPK - S√©rie 12-XX-XX at√© 20-XX-XX
            { name: "12-15-15 MG", n: 12, p: 15, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "13-10-10 MG", n: 13, p: 10, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "13-11-21 MG", n: 13, p: 11, k: 21, ca: 0, s: 0, b: 0, other: 0, price: 2550, freight: 0 },
            { name: "15-00-15 MG", n: 15, p: 0, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2300, freight: 0 },
            { name: "15-00-30 MG", n: 15, p: 0, k: 30, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "15-15-15 MG", n: 15, p: 15, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2550, freight: 0 },
            { name: "16-16-16 MG", n: 16, p: 16, k: 16, ca: 0, s: 0, b: 0, other: 0, price: 2650, freight: 0 },
            { name: "18-18-18 MG", n: 18, p: 18, k: 18, ca: 0, s: 0, b: 0, other: 0, price: 2750, freight: 0 },
            { name: "20-00-10 MG", n: 20, p: 0, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "20-00-20 MG", n: 20, p: 0, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2600, freight: 0 },
            { name: "20-00-30 MG", n: 20, p: 0, k: 30, ca: 0, s: 0, b: 0, other: 0, price: 2750, freight: 0 },
            { name: "20-05-20 MG", n: 20, p: 5, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2700, freight: 0 },
            { name: "20-10-10 MG", n: 20, p: 10, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2650, freight: 0 },
            
            // Formulados NPK - S√©rie 25-XX-XX e acima
            { name: "25-00-25 MG", n: 25, p: 0, k: 25, ca: 0, s: 0, b: 0, other: 0, price: 2900, freight: 0 },
            { name: "26-00-26 MG", n: 26, p: 0, k: 26, ca: 0, s: 0, b: 0, other: 0, price: 3000, freight: 0 },
            { name: "27-00-24 MG", n: 27, p: 0, k: 24, ca: 0, s: 0, b: 0, other: 0, price: 2950, freight: 0 },
            { name: "30-00-20 MG", n: 30, p: 0, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 3050, freight: 0 },
            { name: "33-00-00 MG", n: 33, p: 0, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2700, freight: 0 },
            { name: "36-00-12 MG", n: 36, p: 0, k: 12, ca: 0, s: 0, b: 0, other: 0, price: 3100, freight: 0 },
            
            // NITROCAP
            { name: "NITROCAP 18-10-05 0,5B 0,75Zn GR", n: 18, p: 10, k: 5, ca: 0, s: 0, b: 0.5, other: 0.75, price: 2800, freight: 0 },
            { name: "NITROCAP 20-00-20 MG", n: 20, p: 0, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2650, freight: 0 },
            { name: "NITROCAP 20-00-30 MG", n: 20, p: 0, k: 30, ca: 0, s: 0, b: 0, other: 0, price: 2800, freight: 0 },
            { name: "NITROCAP 20-10-10 MG", n: 20, p: 10, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2700, freight: 0 },
            { name: "NITROCAP 21-00-21 MG", n: 21, p: 0, k: 21, ca: 0, s: 0, b: 0, other: 0, price: 2750, freight: 0 },
            { name: "NITROCAP 25-00-25 MG", n: 25, p: 0, k: 25, ca: 0, s: 0, b: 0, other: 0, price: 2950, freight: 0 },
            { name: "NITROCAP 27-00-24 MG", n: 27, p: 0, k: 24, ca: 0, s: 0, b: 0, other: 0, price: 2900, freight: 0 },
            { name: "NITROCAP 30-00-20 MG", n: 30, p: 0, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 3000, freight: 0 },
            { name: "NITROCAP 30-10-10 MG", n: 30, p: 10, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 3100, freight: 0 },
            { name: "NITROCAP 33-00-00 MG", n: 33, p: 0, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2800, freight: 0 },
            { name: "NITROCAP 36-00-12 MG", n: 36, p: 0, k: 12, ca: 0, s: 0, b: 0, other: 0, price: 3150, freight: 0 },
            { name: "NITROCAP 44-00-00", n: 44, p: 0, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 3000, freight: 0 },
            { name: "NITROCAP 46 GR", n: 46, p: 0, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 3100, freight: 0 },
            
            // CIBRAMIX
            { name: "CIBRAMIX 00-14-18 MG", n: 0, p: 14, k: 18, ca: 0, s: 0, b: 0, other: 0, price: 2200, freight: 0 },
            { name: "CIBRAMIX 00-18-18 MG", n: 0, p: 18, k: 18, ca: 0, s: 0, b: 0, other: 0, price: 2300, freight: 0 },
            { name: "CIBRAMIX 00-20-00 MG", n: 0, p: 20, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 1900, freight: 0 },
            { name: "CIBRAMIX 00-20-20 MG", n: 0, p: 20, k: 20, ca: 0, s: 0, b: 0, other: 0, price: 2350, freight: 0 },
            { name: "CIBRAMIX 00-20-30 MG", n: 0, p: 20, k: 30, ca: 0, s: 0, b: 0, other: 0, price: 2450, freight: 0 },
            { name: "CIBRAMIX 00-22-00 MG", n: 0, p: 22, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2000, freight: 0 },
            { name: "CIBRAMIX 00-25-00 MG", n: 0, p: 25, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2100, freight: 0 },
            { name: "CIBRAMIX 00-25-25 MG", n: 0, p: 25, k: 25, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "CIBRAMIX 00-30-10 MG", n: 0, p: 30, k: 10, ca: 0, s: 0, b: 0, other: 0, price: 2400, freight: 0 },
            { name: "CIBRAMIX 00-30-15 MG", n: 0, p: 30, k: 15, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "CIBRAMIX 00-32-00 MG", n: 0, p: 32, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2300, freight: 0 },
            { name: "CIBRAMIX 00-33-00 MG", n: 0, p: 33, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2350, freight: 0 },
            { name: "CIBRAMIX 00-36-00 MG", n: 0, p: 36, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2500, freight: 0 },
            { name: "CIBRAMIX 00-44-00 MG", n: 0, p: 44, k: 0, ca: 0, s: 0, b: 0, other: 0, price: 2700, freight: 0 },
            
            // KCl com Boro (para teste do filtro)
            { name: "00-00-54 +1B MG", n: 0, p: 0, k: 54, ca: 0, s: 0, b: 1, other: 0, price: 2900, freight: 0 },
            { name: "00-00-57 +0,5B MG", n: 0, p: 0, k: 57, ca: 0, s: 0, b: 0.5, other: 0, price: 2950, freight: 0 },
            
            // Microessenciais
            { name: "MS09E 05 26 25 S9", n: 5, p: 26, k: 25, ca: 0, s: 9, b: 0, other: 0, price: 2800, freight: 0 },
            { name: "MS09E 08 37 11 S9", n: 8, p: 37, k: 11, ca: 0, s: 9, b: 0, other: 0, price: 2900, freight: 0 },
            { name: "ES - Microessentials - S9 10 46 00", n: 10, p: 46, k: 0, ca: 0, s: 9, b: 0, other: 0, price: 3000, freight: 0 },
            { name: "ES - Aspire 00 00 58 + 0,5 B", n: 0, p: 0, k: 58, ca: 0, s: 0, b: 0.5, other: 0, price: 2950, freight: 0 },
            { name: "ES - Cloreto de Potassio 60K2O Granulado PLUS 08 40 06 + 0,05 B", n: 8, p: 40, k: 6, ca: 0, s: 0, b: 0.05, other: 0, price: 2850, freight: 0 },
            { name: "ES - Cloreto de Potassio 60K2O Granulado PLUS 08 37 11 + 0,09 B", n: 8, p: 37, k: 11, ca: 0, s: 0, b: 0.09, other: 0, price: 2900, freight: 0 }
        ];

        const CROP_CONFIG = {
            soja: {
                label: 'Soja',
                nutrients: [
                    { id: 'P', label: 'P‚ÇÇO‚ÇÖ', priority: 'primary', text: '1¬™', val: 90 },
                    { id: 'K', label: 'K‚ÇÇO', priority: 'secondary', text: '2¬™', val: 120 },
                    { id: 'N', label: 'N', priority: null, text: '-', val: 0, disabled: true }
                ]
            },
            milho: {
                label: 'Milho',
                nutrients: [
                    { id: 'N', label: 'N', priority: 'primary', text: '1¬™', val: 120 },
                    { id: 'K', label: 'K‚ÇÇO', priority: 'secondary', text: '2¬™', val: 100 },
                    { id: 'P', label: 'P‚ÇÇO‚ÇÖ', priority: null, text: '3¬™', val: 80 }
                ]
            }
        };

        const state = {
            crop: 'soja',
            fertilizers: [],
            editingIndex: -1,
            filters: {
                kLimitInP: 20,
                preferKClWithB: false,
                excludedFertIds: new Set(),
                costLimit: 0
            }
        };

        const DOMUtils = {
            createElement(tag, options = {}) {
                const el = document.createElement(tag);
                if (options.className) el.className = options.className;
                if (options.id) el.id = options.id;
                if (options.text) el.textContent = options.text;
                if (options.attrs) {
                    Object.entries(options.attrs).forEach(([key, val]) => {
                        el.setAttribute(key, val);
                    });
                }
                if (options.styles) Object.assign(el.style, options.styles);
                return el;
            },

            clearContainer(container) {
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
            },

            formatCurrency(value) {
                return value.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        };

        const Toast = {
            container: document.getElementById('toastContainer'),

            show(message, type = 'info') {
                const toast = DOMUtils.createElement('div', {
                    className: `toast ${type}`,
                    text: message
                });
                this.container.appendChild(toast);
                setTimeout(() => toast.remove(), CONSTANTS.TOAST_DURATION);
            },

            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            info(message) { this.show(message, 'info'); }
        };

        const Storage = {
            save() {
                const data = {
                    crop: state.crop,
                    area: document.getElementById('area').value,
                    price: document.getElementById('grainPrice').value,
                    filters: {
                        kLimitInP: state.filters.kLimitInP,
                        preferKClWithB: state.filters.preferKClWithB,
                        costLimit: state.filters.costLimit,
                        excludedFertIds: Array.from(state.filters.excludedFertIds)
                    },
                    needs: {
                        N: document.getElementById('needN')?.value || 0,
                        P: document.getElementById('needP')?.value || 0,
                        K: document.getElementById('needK')?.value || 0
                    },
                    fertilizers: state.fertilizers
                };

                try {
                    localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(data));
                    this.showSaveBadge();
                } catch (e) {
                    console.error('Erro ao salvar:', e);
                }
            },

            load() {
                try {
                    const data = localStorage.getItem(CONSTANTS.STORAGE_KEY);
                    if (!data) {
                        // Primeira vez: carrega fertilizantes padr√£o
                        state.fertilizers = DEFAULT_FERTILIZERS.map(f => ({...f}));
                        console.log(`‚úÖ Carregados ${state.fertilizers.length} fertilizantes padr√£o`);
                        return false;
                    }

                    const parsed = JSON.parse(data);
                    state.crop = parsed.crop || 'soja';
                    state.fertilizers = Array.isArray(parsed.fertilizers) ? parsed.fertilizers : [];
                    
                    // Se n√£o tem fertilizantes, carrega os padr√µes
                    if (state.fertilizers.length === 0) {
                        state.fertilizers = DEFAULT_FERTILIZERS.map(f => ({...f}));
                        console.log(`‚úÖ Carregados ${state.fertilizers.length} fertilizantes padr√£o (lista estava vazia)`);
                    } else {
                        console.log(`‚úÖ Carregados ${state.fertilizers.length} fertilizantes do localStorage`);
                    }
                    
                    // Restaura filtros
                    if (parsed.filters) {
                        state.filters.kLimitInP = parsed.filters.kLimitInP || 20;
                        state.filters.preferKClWithB = parsed.filters.preferKClWithB || false;
                        state.filters.costLimit = parsed.filters.costLimit || 0;
                        state.filters.excludedFertIds = new Set(parsed.filters.excludedFertIds || []);
                    }
                    
                    document.getElementById('crop').value = state.crop;
                    if (parsed.area) document.getElementById('area').value = parsed.area;
                    if (parsed.price) document.getElementById('grainPrice').value = parsed.price;

                    return parsed.needs || null;
                } catch (e) {
                    // Em caso de erro, carrega fertilizantes padr√£o
                    state.fertilizers = DEFAULT_FERTILIZERS.map(f => ({...f}));
                    console.log(`‚ö†Ô∏è Erro ao carregar, usando ${state.fertilizers.length} fertilizantes padr√£o`);
                    return false;
                }
            },

            showSaveBadge() {
                const badge = document.getElementById('saveBadge');
                badge.classList.add('show');
                setTimeout(() => badge.classList.remove('show'), 2000);
            }
        };

        const Validator = {
            validateFertilizer(data) {
                const errors = [];
                if (!data.name || data.name.trim() === '') errors.push('Nome √© obrigat√≥rio');
                const hasNutrient = data.n > 0 || data.p > 0 || data.k > 0;
                if (!hasNutrient) errors.push('Pelo menos um nutriente (N, P ou K) deve ser maior que zero');
                if (data.price <= 0) errors.push('Pre√ßo deve ser maior que zero');
                const totalPercent = data.n + data.p + data.k + data.ca + data.s + data.b + data.other;
                if (totalPercent > CONSTANTS.MAX_NUTRIENT_PERCENT) {
                    errors.push(`Soma dos nutrientes (${totalPercent.toFixed(1)}%) excede 100%`);
                }
                return errors;
            },

            validateCalculation() {
                const errors = [];
                const area = parseFloat(document.getElementById('area').value) || 0;
                const grainPrice = parseFloat(document.getElementById('grainPrice').value) || 0;
                if (area <= 0) errors.push('√Årea deve ser maior que zero');
                if (grainPrice <= 0) errors.push('Pre√ßo do gr√£o deve ser maior que zero');
                if (state.fertilizers.length === 0) errors.push('Cadastre pelo menos um fertilizante');
                return errors;
            }
        };

        const Renderer = {
            nutrients() {
                const container = document.getElementById('nutrients');
                DOMUtils.clearContainer(container);
                const config = CROP_CONFIG[state.crop];
                
                config.nutrients.forEach(nutrient => {
                    const badge = DOMUtils.createElement('div', {
                        className: `nutrient-badge ${nutrient.priority || ''}`
                    });

                    const label = DOMUtils.createElement('label', { text: nutrient.label });
                    const input = DOMUtils.createElement('input', {
                        attrs: {
                            type: 'number',
                            id: `need${nutrient.id}`,
                            value: nutrient.val,
                            step: '1',
                            min: '0'
                        }
                    });
                    
                    if (nutrient.disabled) {
                        input.disabled = true;
                        input.style.background = '#F5F5F7';
                        input.style.color = '#C7C7CC';
                    }

                    const priority = DOMUtils.createElement('div', {
                        className: 'priority',
                        text: nutrient.text
                    });

                    badge.appendChild(label);
                    badge.appendChild(input);
                    badge.appendChild(priority);
                    container.appendChild(badge);
                });
            },

            fertilizerList() {
                const container = document.getElementById('list');
                DOMUtils.clearContainer(container);

                if (state.fertilizers.length === 0) {
                    const empty = DOMUtils.createElement('div', {
                        className: 'empty',
                        text: 'Nenhum fertilizante cadastrado'
                    });
                    container.appendChild(empty);
                    
                    // Atualiza texto do toggle
                    document.getElementById('listToggleText').textContent = 'Mostrar lista de fertilizantes';
                    return;
                }

                // Atualiza texto do toggle com contador
                const listText = document.getElementById('listToggleText');
                const isVisible = document.getElementById('list').style.display !== 'none';
                listText.textContent = isVisible 
                    ? `Ocultar lista (${state.fertilizers.length} fertilizantes)` 
                    : `Mostrar lista (${state.fertilizers.length} fertilizantes)`;

                state.fertilizers.forEach((fert, index) => {
                    const item = this.createFertilizerCard(fert, index);
                    container.appendChild(item);
                });
            },

            createFertilizerCard(fert, index) {
                const item = DOMUtils.createElement('div', { className: 'fert-item' });
                const header = DOMUtils.createElement('div', { className: 'fert-header' });
                
                const nameDiv = DOMUtils.createElement('div');
                const name = DOMUtils.createElement('div', {
                    className: 'fert-name',
                    text: fert.name
                });

                const formula = DOMUtils.createElement('div', {
                    className: 'fert-formula',
                    text: `${fert.n}-${fert.p}-${fert.k}`
                });
                
                nameDiv.appendChild(name);
                nameDiv.appendChild(formula);

                const actions = DOMUtils.createElement('div', { className: 'fert-actions' });
                const editBtn = DOMUtils.createElement('button', {
                    className: 'btn-icon btn-edit',
                    text: '‚úèÔ∏è'
                });
                editBtn.addEventListener('click', () => FormHandler.edit(index));

                const removeBtn = DOMUtils.createElement('button', {
                    className: 'btn-icon btn-remove',
                    text: '√ó'
                });
                removeBtn.addEventListener('click', () => FormHandler.remove(index));

                actions.appendChild(editBtn);
                actions.appendChild(removeBtn);
                header.appendChild(nameDiv);
                header.appendChild(actions);

                const valuesGrid = DOMUtils.createElement('div', { className: 'values-grid' });
                [
                    { label: 'N', value: fert.n },
                    { label: 'P‚ÇÇO‚ÇÖ', value: fert.p },
                    { label: 'K‚ÇÇO', value: fert.k },
                    { label: 'Ca', value: fert.ca },
                    { label: 'S', value: fert.s }
                ].forEach(n => {
                    const valueItem = DOMUtils.createElement('div', { className: 'value-item' });
                    const label = DOMUtils.createElement('div', {
                        className: 'value-label',
                        text: n.label
                    });
                    const value = DOMUtils.createElement('div', {
                        className: 'value',
                        text: `${n.value.toFixed(1)}%`
                    });
                    valueItem.appendChild(label);
                    valueItem.appendChild(value);
                    valuesGrid.appendChild(valueItem);
                });

                const pricesGrid = DOMUtils.createElement('div', { className: 'prices-grid' });
                const priceItem = DOMUtils.createElement('div', { className: 'price-item' });
                priceItem.innerHTML = `<div class="value-label">Pre√ßo</div><div class="value">R$ ${fert.price.toFixed(0)}/ton</div>`;
                
                const freightItem = DOMUtils.createElement('div', { className: 'price-item' });
                freightItem.innerHTML = `<div class="value-label">Frete</div><div class="value">R$ ${fert.freight.toFixed(0)}/ton</div>`;

                pricesGrid.appendChild(priceItem);
                pricesGrid.appendChild(freightItem);

                item.appendChild(header);
                item.appendChild(valuesGrid);
                item.appendChild(pricesGrid);
                return item;
            },

            results(combinations, grainPrice) {
                const container = document.getElementById('results');
                DOMUtils.clearContainer(container);

                if (combinations.length === 0) {
                    Toast.error('Nenhuma combina√ß√£o v√°lida encontrada');
                    return;
                }

                if (combinations[0]) {
                    container.appendChild(this.createResultCard(combinations[0], 'best', null));
                }

                if (combinations[1]) {
                    const diff = combinations[1].total - combinations[0].total;
                    container.appendChild(this.createResultCard(combinations[1], 'second', diff));
                }
            },

            createResultCard(combo, type, diff) {
                const card = DOMUtils.createElement('div', { className: `result ${type}` });
                const title = DOMUtils.createElement('h3');
                
                if (type === 'best') {
                    title.textContent = `ü•á ${combo.name} `;
                    const badge = DOMUtils.createElement('span', {
                        className: 'badge badge-best',
                        text: 'Melhor'
                    });
                    title.appendChild(badge);
                } else {
                    title.textContent = `ü•à ${combo.name}`;
                }

                const rows = [
                    [combo.f1.name, `${combo.f1.dose.toFixed(1)} kg/ha`],
                    ['Total:', `${combo.f1.ton.toFixed(2)} ton`],
                    ['Custo:', `R$ ${DOMUtils.formatCurrency(combo.f1.cost)}`],
                    ['spacer'],
                    [combo.f2.name, `${combo.f2.dose.toFixed(1)} kg/ha`],
                    ['Total:', `${combo.f2.ton.toFixed(2)} ton`],
                    ['Custo:', `R$ ${DOMUtils.formatCurrency(combo.f2.cost)}`]
                ];

                rows.forEach(r => {
                    if (r[0] === 'spacer') {
                        card.appendChild(DOMUtils.createElement('div', { styles: { height: '8px' } }));
                    } else {
                        const row = DOMUtils.createElement('div', { className: 'result-row' });
                        row.innerHTML = `<span>${r[0]}</span><strong>${r[1]}</strong>`;
                        card.appendChild(row);
                    }
                });

                const totalRow = DOMUtils.createElement('div', { className: 'result-total' });
                totalRow.innerHTML = `<span>TOTAL:</span><strong>R$ ${DOMUtils.formatCurrency(combo.total)}</strong>`;
                card.appendChild(totalRow);

                const grainInfo = DOMUtils.createElement('div', { className: 'grain-info' });
                grainInfo.innerHTML = `
                    <div class="grain-row"><span>R$/ha:</span><span class="grain-value">${combo.perHa.toFixed(2)}</span></div>
                    ${diff !== null ? `<div class="grain-row"><span>Diferen√ßa:</span><span class="grain-value">+ R$ ${diff.toFixed(2)}</span></div>` : ''}
                    <div class="grain-row"><span>Sacas:</span><span class="grain-value">${combo.sacks.toFixed(2)} sc/ha</span></div>
                `;
                card.appendChild(grainInfo);
                return card;
            }
        };

        const FormHandler = {
            getFormData() {
                return {
                    name: document.getElementById('name').value.trim(),
                    n: parseFloat(document.getElementById('n').value) || 0,
                    p: parseFloat(document.getElementById('p').value) || 0,
                    k: parseFloat(document.getElementById('k').value) || 0,
                    ca: parseFloat(document.getElementById('ca').value) || 0,
                    s: parseFloat(document.getElementById('s').value) || 0,
                    b: parseFloat(document.getElementById('b').value) || 0,
                    other: parseFloat(document.getElementById('other').value) || 0,
                    price: parseFloat(document.getElementById('price').value) || 0,
                    freight: parseFloat(document.getElementById('freight').value) || 0
                };
            },

            clearForm() {
                document.getElementById('name').value = '';
                ['n', 'p', 'k', 'ca', 's', 'b', 'other'].forEach(id => {
                    document.getElementById(id).value = '0';
                });
                document.getElementById('price').value = '';
                document.getElementById('freight').value = '0';
                state.editingIndex = -1;
                this.toggleEditMode(false);
            },

            toggleEditMode(isEditing) {
                document.getElementById('addBtn').style.display = isEditing ? 'none' : 'block';
                document.getElementById('saveBtn').style.display = isEditing ? 'block' : 'none';
                document.getElementById('cancelBtn').style.display = isEditing ? 'block' : 'none';
            },

            add() {
                const data = this.getFormData();
                const errors = Validator.validateFertilizer(data);

                if (errors.length > 0) {
                    Toast.error(errors.join('\n'));
                    return;
                }

                state.fertilizers.push(data);
                this.clearForm();
                Renderer.fertilizerList();
                Storage.save();
                Toast.success('Fertilizante adicionado!');
            },

            edit(index) {
                state.editingIndex = index;
                const fert = state.fertilizers[index];

                document.getElementById('name').value = fert.name;
                document.getElementById('n').value = fert.n;
                document.getElementById('p').value = fert.p;
                document.getElementById('k').value = fert.k;
                document.getElementById('ca').value = fert.ca || 0;
                document.getElementById('s').value = fert.s || 0;
                document.getElementById('b').value = fert.b || 0;
                document.getElementById('other').value = fert.other || 0;
                document.getElementById('price').value = fert.price;
                document.getElementById('freight').value = fert.freight;

                this.toggleEditMode(true);
                document.getElementById('name').scrollIntoView({ behavior: 'smooth', block: 'center' });
            },

            saveEdit() {
                if (state.editingIndex === -1) return;

                const data = this.getFormData();
                const errors = Validator.validateFertilizer(data);

                if (errors.length > 0) {
                    Toast.error(errors.join('\n'));
                    return;
                }

                state.fertilizers[state.editingIndex] = data;
                this.clearForm();
                Renderer.fertilizerList();
                Storage.save();
                Toast.success('Fertilizante atualizado!');
            },

            remove(index) {
                if (confirm('Remover este fertilizante?')) {
                    state.fertilizers.splice(index, 1);
                    if (state.editingIndex === index) {
                        this.clearForm();
                    } else if (state.editingIndex > index) {
                        state.editingIndex--;
                    }
                    Renderer.fertilizerList();
                    Storage.save();
                    Toast.success('Fertilizante removido');
                }
            },

            cancel() {
                this.clearForm();
            }
        };

        const ModalHandler = {
            open() {
                const modalBody = document.getElementById('modalBody');
                DOMUtils.clearContainer(modalBody);

                // Renderiza lista de fertilizantes com checkboxes
                state.fertilizers.forEach((fert, index) => {
                    const item = DOMUtils.createElement('div', { className: 'modal-fert-item' });
                    
                    const checkbox = DOMUtils.createElement('input', {
                        className: 'modal-checkbox',
                        attrs: {
                            type: 'checkbox',
                            id: `modal-fert-${index}`,
                            checked: state.excludedIds.has(index)
                        }
                    });

                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            state.excludedIds.add(index);
                            item.classList.add('excluded');
                        } else {
                            state.excludedIds.delete(index);
                            item.classList.remove('excluded');
                        }
                    });

                    const info = DOMUtils.createElement('div', { className: 'modal-fert-info' });
                    const name = DOMUtils.createElement('div', {
                        className: 'modal-fert-name',
                        text: fert.name
                    });
                    const formula = DOMUtils.createElement('div', {
                        className: 'modal-fert-formula',
                        text: `${fert.n}-${fert.p}-${fert.k}`
                    });

                    info.appendChild(name);
                    info.appendChild(formula);

                    item.appendChild(checkbox);
                    item.appendChild(info);

                    // Clique no item tamb√©m marca/desmarca
                    item.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });

                    if (state.excludedIds.has(index)) {
                        item.classList.add('excluded');
                    }

                    modalBody.appendChild(item);
                });

                document.getElementById('modalOverlay').classList.add('show');
            },

            close() {
                document.getElementById('modalOverlay').classList.remove('show');
            }
        };

        const ModalHandler = {
            open() {
                // Restaura valores dos filtros
                document.getElementById('kLimitInP').value = state.filters.kLimitInP;
                document.getElementById('preferKClWithB').checked = state.filters.preferKClWithB;
                document.getElementById('costLimit').value = state.filters.costLimit;

                // Popula lista de fertilizantes para exclus√£o
                const checkList = document.getElementById('fertilizersCheckList');
                DOMUtils.clearContainer(checkList);

                if (state.fertilizers.length === 0) {
                    checkList.innerHTML = '<p style="text-align: center; color: var(--gray-600); font-size: 12px; padding: 12px;">Nenhum fertilizante cadastrado</p>';
                } else {
                    state.fertilizers.forEach((fert, index) => {
                        const item = DOMUtils.createElement('div', {
                            className: `fert-check-item ${state.filters.excludedFertIds.has(index) ? 'excluded' : ''}`
                        });

                        const checkbox = DOMUtils.createElement('input', {
                            attrs: {
                                type: 'checkbox',
                                id: `fert-check-${index}`,
                                checked: state.filters.excludedFertIds.has(index)
                            }
                        });

                        checkbox.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                state.filters.excludedFertIds.add(index);
                                item.classList.add('excluded');
                            } else {
                                state.filters.excludedFertIds.delete(index);
                                item.classList.remove('excluded');
                            }
                        });

                        const info = DOMUtils.createElement('div', { className: 'fert-check-info' });
                        const name = DOMUtils.createElement('div', {
                            className: 'fert-check-name',
                            text: fert.name
                        });
                        const formula = DOMUtils.createElement('div', {
                            className: 'fert-check-formula',
                            text: `${fert.n}-${fert.p}-${fert.k}`
                        });

                        info.appendChild(name);
                        info.appendChild(formula);
                        item.appendChild(checkbox);
                        item.appendChild(info);

                        // Clique no item tamb√©m marca/desmarca
                        item.addEventListener('click', (e) => {
                            if (e.target !== checkbox) {
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        });

                        checkList.appendChild(item);
                    });
                }

                document.getElementById('modalOverlay').classList.add('show');
            },

            close() {
                document.getElementById('modalOverlay').classList.remove('show');
            },

            saveFilters() {
                state.filters.kLimitInP = parseFloat(document.getElementById('kLimitInP').value) || 0;
                state.filters.preferKClWithB = document.getElementById('preferKClWithB').checked;
                state.filters.costLimit = parseFloat(document.getElementById('costLimit').value) || 0;
                // excludedFertIds j√° est√° sendo atualizado em tempo real
            }
        };

        const Calculator = {
            async calculate() {
                const errors = Validator.validateCalculation();
                if (errors.length > 0) {
                    Toast.error(errors.join('\n'));
                    return;
                }

                document.getElementById('loading').classList.add('show');
                await new Promise(resolve => setTimeout(resolve, 50));

                try {
                    const area = parseFloat(document.getElementById('area').value);
                    const grainPrice = parseFloat(document.getElementById('grainPrice').value);
                    
                    const needs = {
                        N: parseFloat(document.getElementById('needN')?.value) || 0,
                        P: parseFloat(document.getElementById('needP')?.value) || 0,
                        K: parseFloat(document.getElementById('needK')?.value) || 0
                    };

                    const kLimitInP = state.filters.kLimitInP;
                    const preferKClWithB = state.filters.preferKClWithB;
                    const costLimit = state.filters.costLimit;

                    // FILTRO 1: Remove fertilizantes exclu√≠dos manualmente
                    let validFerts = state.fertilizers.filter((_, index) => !state.filters.excludedFertIds.has(index));

                    // FILTRO 2: Remove fertilizantes com P+K se K exceder limite
                    validFerts = validFerts.filter(f => {
                        if (f.p > 0 && f.k > 0 && kLimitInP > 0) {
                            const doseForP = (needs.P * 100) / f.p;
                            const kFromThisFert = (doseForP * f.k) / 100;
                            
                            if (kFromThisFert > kLimitInP) {
                                console.log(`Excluindo ${f.name}: K=${kFromThisFert.toFixed(1)} > limite ${kLimitInP}`);
                                return false;
                            }
                        }
                        return true;
                    });

                    // FILTRO 3: Se preferir KCl+B, d√° prioridade (aplica boost no c√°lculo de custo)
                    const hasBBoost = (fert) => {
                        if (!preferKClWithB) return 1;
                        // Se fertilizante tem K>0 e B>0, aplica desconto de 5% no custo
                        if (fert.k > 0 && fert.b > 0) {
                            return 0.95; // 5% de desconto simulado
                        }
                        return 1;
                    };
                    
                    if (validFerts.length < 2) {
                        Toast.error('√â necess√°rio pelo menos 2 fertilizantes v√°lidos ap√≥s aplicar filtros');
                        return;
                    }
                    
                    const combinations = [];

                    for (let i = 0; i < validFerts.length; i++) {
                        for (let j = i + 1; j < validFerts.length; j++) {
                            const f1 = validFerts[i];
                            const f2 = validFerts[j];

                            let dose1 = 0, dose2 = 0;

                            // Prioridade P
                            if (needs.P > 0) {
                                if (f1.p > 0 && f2.p === 0) {
                                    dose1 = (needs.P * 100) / f1.p;
                                } else if (f2.p > 0 && f1.p === 0) {
                                    dose2 = (needs.P * 100) / f2.p;
                                } else if (f1.p > f2.p) {
                                    dose1 = (needs.P * 100) / f1.p;
                                } else if (f2.p > 0) {
                                    dose2 = (needs.P * 100) / f2.p;
                                }
                            }

                            // Depois K
                            const kGot1 = (dose1 * f1.k) / 100;
                            const kGot2 = (dose2 * f2.k) / 100;
                            const kNeed = Math.max(0, needs.K - kGot1 - kGot2);

                            if (kNeed > 0) {
                                if (f1.k > 0 && (dose1 === 0 || f1.p === 0)) {
                                    dose1 = Math.max(dose1, (kNeed * 100) / f1.k);
                                } else if (f2.k > 0 && (dose2 === 0 || f2.p === 0)) {
                                    dose2 = Math.max(dose2, (kNeed * 100) / f2.k);
                                }
                            }

                            // Por √∫ltimo N
                            const nGot1 = (dose1 * f1.n) / 100;
                            const nGot2 = (dose2 * f2.n) / 100;
                            const nNeed = Math.max(0, needs.N - nGot1 - nGot2);

                            if (nNeed > 0) {
                                if (f1.n > 0 && dose1 === 0) dose1 = (nNeed * 100) / f1.n;
                                else if (f2.n > 0 && dose2 === 0) dose2 = (nNeed * 100) / f2.n;
                            }

                            if (dose1 > 0 || dose2 > 0) {
                                const ton1 = (dose1 / 1000) * area;
                                const ton2 = (dose2 / 1000) * area;
                                
                                // Aplica boost de KCl+B
                                const cost1 = ton1 * (f1.price + f1.freight) * hasBBoost(f1);
                                const cost2 = ton2 * (f2.price + f2.freight) * hasBBoost(f2);
                                const total = cost1 + cost2;
                                const perHa = total / area;

                                // FILTRO 4: Remove se exceder limite de custo
                                if (costLimit > 0 && perHa > costLimit) {
                                    continue;
                                }

                                combinations.push({
                                    name: `${f1.name} + ${f2.name}`,
                                    f1: { name: f1.name, dose: dose1, ton: ton1, cost: cost1 },
                                    f2: { name: f2.name, dose: dose2, ton: ton2, cost: cost2 },
                                    total,
                                    perHa,
                                    sacks: perHa / grainPrice
                                });
                            }
                        }
                    }

                    combinations.sort((a, b) => a.total - b.total);
                    Renderer.results(combinations, grainPrice);

                } finally {
                    document.getElementById('loading').classList.remove('show');
                }
            }
        };

        function init() {
            const savedNeeds = Storage.load();
            document.getElementById('grainLabel').textContent = `${CROP_CONFIG[state.crop].label} (R$/sc)`;
            Renderer.nutrients();

            if (savedNeeds) {
                setTimeout(() => {
                    if (document.getElementById('needN')) document.getElementById('needN').value = savedNeeds.N;
                    if (document.getElementById('needP')) document.getElementById('needP').value = savedNeeds.P;
                    if (document.getElementById('needK')) document.getElementById('needK').value = savedNeeds.K;
                }, 0);
            }

            // Renderiza lista E mostra ela por padr√£o na primeira vez
            Renderer.fertilizerList();
            
            // Se tem fertilizantes, mostra a lista por padr√£o
            const list = document.getElementById('list');
            const listText = document.getElementById('listToggleText');
            const listIcon = document.getElementById('listIcon');
            
            if (state.fertilizers.length > 0) {
                list.style.display = 'block';
                listText.textContent = `Ocultar lista (${state.fertilizers.length} fertilizantes)`;
                listIcon.classList.add('open');
            } else {
                list.style.display = 'none';
                listText.textContent = 'Mostrar lista de fertilizantes';
                listIcon.classList.remove('open');
            }

            document.getElementById('crop').addEventListener('change', () => {
                state.crop = document.getElementById('crop').value;
                document.getElementById('grainLabel').textContent = `${CROP_CONFIG[state.crop].label} (R$/sc)`;
                Renderer.nutrients();
                Storage.save();
            });

            document.getElementById('area').addEventListener('input', Storage.save);
            document.getElementById('grainPrice').addEventListener('input', Storage.save);

            document.getElementById('toggleSecondary').addEventListener('click', () => {
                const el = document.getElementById('secondary');
                const icon = document.getElementById('icon');
                el.classList.toggle('show');
                icon.classList.toggle('open');
            });

            document.getElementById('toggleFormCard').addEventListener('click', () => {
                const formCard = document.getElementById('formCard');
                const icon = document.getElementById('formIcon');
                
                if (formCard.style.display === 'none') {
                    formCard.style.display = 'block';
                    icon.classList.add('open');
                } else {
                    formCard.style.display = 'none';
                    icon.classList.remove('open');
                }
            });

            document.getElementById('toggleList').addEventListener('click', () => {
                const list = document.getElementById('list');
                const icon = document.getElementById('listIcon');
                const text = document.getElementById('listToggleText');
                
                if (list.style.display === 'none' || !list.style.display) {
                    list.style.display = 'block';
                    icon.classList.add('open');
                    text.textContent = `Ocultar lista (${state.fertilizers.length} fertilizantes)`;
                } else {
                    list.style.display = 'none';
                    icon.classList.remove('open');
                    text.textContent = `Mostrar lista (${state.fertilizers.length} fertilizantes)`;
                }
            });

            document.getElementById('addBtn').addEventListener('click', () => FormHandler.add());
            document.getElementById('saveBtn').addEventListener('click', () => FormHandler.saveEdit());
            document.getElementById('cancelBtn').addEventListener('click', () => FormHandler.cancel());
            
            // Abre modal de filtros ao clicar em Calcular
            document.getElementById('calcBtn').addEventListener('click', () => ModalHandler.open());
            
            // Modal handlers
            document.getElementById('modalCancel').addEventListener('click', () => ModalHandler.close());
            document.getElementById('modalConfirm').addEventListener('click', () => {
                ModalHandler.saveFilters();
                ModalHandler.close();
                Calculator.calculate();
            });

            document.getElementById('nutrients').addEventListener('input', Storage.save);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
